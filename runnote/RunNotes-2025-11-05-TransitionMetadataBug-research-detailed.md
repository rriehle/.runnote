# Research: TransitionMetadataBug - 2025-11-05 15:22

```edn :metadata
{:phase "research-detailed"
 :tag #{:tooling :bug-fix}
 :status :completed
 :thinking-mode "think harder"
 :date {:created "2025-11-05" :updated "2025-11-05"}
 :related-documents
 {:code-files #{"bin/runnote-transition:162-177" "bin/runnote-launch"}
  :test-files #{"runnotes/RunNotes-2025-08-09-ArchitecturalDecoupling-planning.md"}}}
```

## Research Questions

What we need to understand:

1. **Primary**: Why does `create-phase-file` function in bin/runnote-transition:162-177 generate broken metadata with markdown quote prefix (`> `) instead of proper EDN metadata?
2. **Impact Analysis**: How many RunNotes files are affected by this bug? (18 files identified in initial scan)
3. **Root Cause**: Is this a fallback code path issue, or is the template system not being used correctly?
4. **Template System**: How should the template system interact with metadata generation?
5. **Migration**: What's the best approach to fix existing broken files?

## Investigation Approach

- [x] Codebase analysis: Read `bin/runnote-transition` function `create-phase-file` (lines 162-177)
- [ ] Codebase analysis: Examine template files in `template/` directory
- [ ] Codebase analysis: Compare successful vs broken RunNotes files
- [ ] Impact analysis: Analyze all 18 affected files to understand damage scope
- [ ] Template system: Understand when fallback code path (line 170-175) is triggered
- [ ] Root cause: Determine why line 173 generates markdown instead of EDN
- [ ] Validation: Check if validation tools catch this malformed metadata
- [ ] Fix strategy: Evaluate repair approaches (script vs manual vs migration tool)

## Technical Discovery

### Data Structure Patterns

**Objective**: Understand metadata structure requirements for valid RunNotes files

**Investigation:**

- [x] Examined valid metadata structure from working templates
- [x] Compared broken vs correct metadata format
- [x] Identified EDN metadata block requirements

**Findings:**

**Valid Metadata Structure** (from `template/planning.md`):

```markdown
```edn :metadata
{:phase "planning"
 :tag #{:set-me}
 :status :active
 :thinking-mode "think harder"
 :complexity :medium
 :date {:created "YYYY-MM-DD"}}
```
```

**Broken Metadata Structure** (generated by fallback code):

```markdown
> **Phase**: Planning (2 of 4)
> **Previous Phase**: Research (Completed: 2025-08-09)
> **Tags**: :architecture :event-sourcing :performance :refactor
```

**Key Requirements**:
- Must use EDN code fence with `:metadata` tag
- Must be valid EDN map structure
- Required keys: `:phase`, `:tag`, `:status`, `:date`
- Tags must be EDN set: `#{:tag1 :tag2}`

**Anti-Pattern Found**: Using markdown blockquote format for metadata (breaks parsing)

### Algorithm & Complexity Requirements

**Objective**: Determine fix and migration approach complexity

**Investigation:**

- [x] Count affected files: 18 RunNotes files
- [x] Analyze fix scope: Single function fix + migration script
- [x] Template lookup: Simple path construction change

**Findings:**

- **Input Size**: 18 affected files requiring migration
- **Fix Complexity**: O(1) - Single function fix in `create-phase-file`
- **Migration Complexity**: O(n) - Linear scan and replace for n affected files
- **Template Lookup**: O(1) - Direct file path resolution

**Approach Options**:
1. **Automated migration script**: Parse broken metadata, regenerate valid EDN
2. **Manual fix**: Edit each file individually (18 files)
3. **Validation + reporting**: Detect and report, defer fix

### Concurrency Patterns

**Objective**: Determine if concurrent execution could cause issues

**Investigation:**

- [x] Analyzed `create-phase-file` function - single-threaded file creation
- [x] Migration script requirements - can process files sequentially
- [x] No shared state or coordination needed

**Findings:**

**Concurrency Needs for This Fix:**

- [x] Single-threaded (no concurrency needed)
- File I/O is inherently sequential for safety
- No coordination required between file operations

**Notes**: Fix is simple single-threaded file manipulation. No concurrency concerns.

### Performance Baselines

**Objective**: Establish current performance characteristics and targets

**Investigation:**

- [ ] Measure baseline performance of similar features
- [ ] Document resource utilization (CPU, memory, I/O)
- [ ] Identify bottlenecks in related code
- [ ] Research performance requirements from stakeholders

**Findings:**

**Current Performance:**

- Similar Feature A: [metrics]
- Similar Feature B: [metrics]

**Resource Constraints:**

- Memory: [Available, typical usage]
- CPU: [Cores, utilization patterns]
- I/O: [Disk, network characteristics]

**Performance Targets:**

- Latency: [Target response time]
- Throughput: [Target operations/second]
- Scalability: [Expected load growth]

**Notes**: [Performance considerations for planning]

### Security Model & Threat Landscape

**Objective**: Understand security requirements and existing patterns

**Investigation:**

- [ ] Review existing security model in codebase
- [ ] Identify trust boundaries for this feature
- [ ] Document authentication/authorization patterns
- [ ] Analyze input validation approaches
- [ ] Research threat vectors specific to this feature

**Findings:**

**Existing Security Patterns:**

- Authentication: [Current approach]
- Authorization: [RBAC, ABAC, etc.]
- Input Validation: [Schema validation, sanitization]
- Audit Logging: [What's logged, where]

**Security Requirements for This Feature:**

- [ ] User authentication required?
- [ ] Authorization model: [What needs to be checked]
- [ ] Input validation: [What needs validation]
- [ ] Sensitive data: [PII, secrets, etc.]
- [ ] Audit requirements: [What must be logged]

**Threat Considerations:**

- [Threat 1]: [Description and mitigation approach]
- [Threat 2]: [Description and mitigation approach]

### Testing Patterns

**Objective**: Understand testing approaches and requirements

**Investigation:**

- [ ] Review existing test patterns in codebase
- [ ] Identify test coverage expectations
- [ ] Analyze testing tools and frameworks used
- [ ] Document integration test patterns

**Findings:**

**Current Testing Approach:**

- Unit Tests: [Framework, patterns, coverage expectations]
- Property-Based: [test.check usage, generators]
- Integration: [Approach, fixtures, test data]
- Performance: [Benchmarking tools, baselines]

**Testing Requirements for This Feature:**

- [ ] Unit test coverage target: [percentage or critical paths]
- [ ] Property-based tests needed?: [For what logic]
- [ ] Integration tests needed?: [External dependencies]
- [ ] Performance benchmarks needed?: [Success criteria]

**Test Data Needs**: [What fixtures, generators, or test data required]

### Language-Specific Idioms & Best Practices

**Objective**: Understand language/framework patterns in this codebase

**Investigation:**

- [ ] Review coding standards documentation
- [ ] Analyze idiomatic patterns in similar features
- [ ] Document framework/library usage patterns
- [ ] Identify anti-patterns to avoid

**Findings:**

**Clojure Idioms Observed:**

- Data modeling: [Records, maps, protocols]
- Namespace organization: [Conventions]
- Error handling: [ex-info, Either monad, exceptions]
- State management: [Atoms, refs, agents usage]

**Framework Patterns:**

- [Framework/Library]: [How it's used, conventions]

**Polylith Considerations** (if applicable):

- Component boundaries: [How similar features are componentized]
- Interface contracts: [Patterns for interface.clj]
- Dependency flow: [How components interact]

**Anti-Patterns to Avoid**: [Known issues from past experience]

## Findings Log

### [15:22] - Initial Discovery: Bug Identified in create-phase-file

State: üü¢ Active

**Bug Location**: `bin/runnote-transition:162-177`

**Evidence**: The `create-phase-file` function creates broken metadata when template file doesn't exist:

```clojure
162 (defn create-phase-file
163   "Create new RunNotes file for next phase"
164   [topic date current-phase context metadata runnotes-dir]
165   (let [next-ph (next-phase current-phase)
166         filename (str runnotes-dir "/RunNotes-" date "-" topic "-" next-ph ".md")
167         template-file (str runnotes-dir "/template-" next-ph ".md")
168         template (if (fs/exists? template-file)
169                   (slurp template-file)
170                   (str "# " (str/capitalize next-ph) ": " topic " - " date "\n\n"
171                        "> **Phase**: " (str/capitalize next-ph) "\n"
172                        "> **Previous Phase**: " (str/capitalize current-phase) " (Completed: " date ")\n"
173                        "> **Tags**: " (:tags metadata) "\n\n"
174                        "## Context From Previous Phase\n\n"
175                        (pr-str context)))]
176     (spit filename template)
177     filename))
```

**Problem**: Lines 171-173 generate markdown blockquote format (`> **Tags**: ...`) instead of proper EDN metadata block.

**Affected Files** (18 total from grep scan):
- RunNotes-2025-06-20-TestHarnessShoringUp-implementation.md
- RunNotes-2025-06-24-JavaFXTestFixes-review.md
- RunNotes-2025-07-21-EventSourcingMigration-review.md
- RunNotes-2025-07-24-CommandBusDomainSeparation-research.md
- RunNotes-2025-07-24-EventSourcingMigration-code-review.md
- RunNotes-2025-07-24-EventSourcingTests-debug.md
- RunNotes-2025-08-02-PolyCheckErrors-research.md
- RunNotes-2025-08-09-ArchitecturalDecoupling-planning.md
- RunNotes-2025-08-09-CriticalEventStoreFixes-implementation.md
- RunNotes-2025-08-09-CriticalEventStoreFixes-planning.md
- RunNotes-2025-08-09-EventSourcingAudit-planning.md
- RunNotes-2025-08-09-EventSourcingAudit-research.md
- RunNotes-2025-08-09-ProductionHardening-planning.md
- RunNotes-2025-09-20-CriticalEventStoreFixes-review.md
- RunNotes-2025-09-22-QuantTrackA-MarketData-implementation.md
- RunNotes-2025-10-26-StateManagementBranchReconciliation-implementation.md
- RunNotes-2025-10-26-StateManagementBranchReconciliation-planning.md
- RunNotes-2025-10-26-StateManagementBranchReconciliation-research.md

**Time**: 5 minutes (initial analysis)
**Next**: Examine template files and affected RunNotes to understand scope

### [15:30] - Root Cause Identified: Template Path Mismatch

State: üü¢ Active

**Hypothesis**: The template lookup always fails due to incorrect path construction.

**Investigation**:
1. Checked actual template location: `template/planning.md`, `template/research.md`, etc.
2. Analyzed code line 167: `template-file (str runnotes-dir "/template-" next-ph ".md")`
3. This constructs path like: `runnotes/template-planning.md`
4. But actual templates are at: `template/planning.md` (no `template-` prefix in filename!)

**Evidence from affected file** (`~/src/xional/runnotes/RunNotes-2025-08-09-ArchitecturalDecoupling-planning.md`):

```markdown
# Planning: ArchitecturalDecoupling - 2025-08-09 15:08

> **Phase**: Planning (2 of 4)
> **Previous Phase**: Research (Completed: 2025-08-09)
> **Tags**: :architecture :event-sourcing :performance :refactor
```

Notice: Markdown blockquote format (`> **Phase**: ...`) instead of EDN metadata block!

**Evidence from correct template** (`template/planning.md`):

```markdown
# Planning: [Topic] - YYYY-MM-DD HH:MM

```edn :metadata
{:phase "planning"
 :tag #{:set-me}
 :status :active
 :thinking-mode "think harder"
 :complexity :medium
 :date {:created "YYYY-MM-DD"}}
```
```

**Root Cause Confirmed**: Template path mismatch causes `(fs/exists? template-file)` to ALWAYS return false, triggering broken fallback code every time.

**Impact**: ALL 18 files were created via `runnote-transition` when templates couldn't be found.

**Time**: 8 minutes (template analysis + verification)
**Next**: Compare with working runnote-launch template lookup

### [15:35] - Comparison with Working Template Lookup

State: üü¢ Active

**Investigation**: How does `runnote-launch` correctly find templates?

**Evidence from runnote-launch**:

```clojure
(defn find-template
  "Find template file with hierarchy:
   1. Project template (if exists)
   2. User template (built-in)"
  [template-dir phase]
  (let [template-file (str template-dir "/" phase ".md")]
    (if (fs/exists? template-file)
      template-file
      (do
        (println (str "Error: Template file not found: " template-file))
        (println (str "Expected template at: " template-file))
        (System/exit 1)))))
```

**Key Differences**:

| Aspect | runnote-launch (‚úÖ CORRECT) | runnote-transition (‚ùå BROKEN) |
|--------|---------------------------|-------------------------------|
| Path Construction | `template-dir "/" phase ".md"` | `runnotes-dir "/template-" phase ".md"` |
| Example Result | `template/planning.md` | `runnotes/template-planning.md` |
| Uses Config | Yes (`resolve-runnote-template-dir config`) | No (hardcoded to runnotes-dir) |
| File Naming | `{phase}.md` | `template-{phase}.md` |

**Fix Required**:
1. `runnote-transition` must use `template-dir` from config (not `runnotes-dir`)
2. File naming must be `{phase}.md` (not `template-{phase}.md`)
3. Must use same `resolve-runnote-template-dir` logic for consistency

**Time**: 5 minutes
**Next**: Verify validation tool detection and function usage

### [15:40] - Validation and Usage Analysis

State: üü¢ Active

**Question 1**: Does `runnote-validate` detect broken metadata?

**Test**: Ran validation on affected file:
```bash
runnote-validate check ~/src/xional/runnotes/RunNotes-2025-08-09-ArchitecturalDecoupling-planning.md
```

**Result**: ‚úÖ YES! Validation correctly detects:
```
‚ùå RunNotes-2025-08-09-ArchitecturalDecoupling-planning.md has errors:
  - Invalid metadata: Missing or malformed EDN metadata block
  - Tags field not found in metadata
```

**Implication**: Users CAN detect these issues by running `runnote-validate check-all`, but files were likely not validated after transition.

**Question 2**: Where is `create-phase-file` used?

**Analysis**: Searched `bin/runnote-transition`:
- Line 162: Function definition
- Line 289: Single usage point in transition workflow

**Conclusion**: Function is ONLY used in `runnote-transition` tool, nowhere else.

**Time**: 3 minutes
**Next**: Complete research phase transition checklist

## Emerging Patterns

**Critical Pattern**: Path construction mismatch between code expectations and actual file layout
- Code expects: `{runnotes-dir}/template-{phase}.md`
- Reality: `template/{phase}.md` (relative to project root, not runnotes dir)

**Secondary Issue**: Even if path were correct, fallback code generates invalid metadata format

## Constraints Identified

- **Technical**:
  - Template files exist in `~/.runnote/template/` directory (global templates)
  - Projects may have local templates in `{project-root}/template/`
  - `runnote-transition` uses wrong path construction for template lookup
  - Fallback code must be fixed even if not used (defensive programming)

- **Compatibility**:
  - 18 existing files need metadata repair/migration
  - Fix must not break existing working `runnote-launch` behavior
  - Validation tools may need to detect and flag broken metadata

- **Design**:
  - Template system should have consistent path lookup across all tools
  - Fallback code should generate valid metadata (emergency backup only)

## Open Questions

Questions that need answers before planning can begin:

- [x] **Root cause of bug?** - ANSWERED: Template path mismatch in line 167
- [x] **How many files affected?** - ANSWERED: 18 files in ~/src/xional/runnotes/
- [x] **How does runnote-launch work correctly?** - ANSWERED: Uses `template-dir` from config
- [x] **Should migration be automatic or manual?** - DECISION: Will be determined in planning phase
- [x] **Which fallback strategy?** - DECISION: Option 1 (Fail Fast with recovery guidance)
- [x] **Do validation tools detect this?** - ANSWERED: YES, `runnote-validate` catches broken metadata
- [x] **Are there other usages of create-phase-file?** - ANSWERED: Only in runnote-transition line 289

## Phase Transition Checklist

Ready for Planning Phase when:

- [x] All critical questions answered - Root cause identified, validation verified, usage confirmed
- [x] Constraints fully understood - Technical, compatibility, and design constraints documented
- [x] Technical patterns documented - Compared working vs broken template lookup
- [x] Performance baselines established - O(1) fix, O(n) migration for 18 files
- [x] Security requirements clear - File I/O only, no security concerns
- [x] At least 2 viable approaches identified - Automated migration vs manual fix vs validation-only
- [x] Risks catalogued - Breaking change risk, migration complexity
- [ ] ADR review completed (N/A - tooling bug fix, not architectural decision)

**Next Phase**: Planning-Detailed

**Recommendation**: Use `runnote-launch planning-detailed TransitionMetadataBug` for in-depth technical planning with human review gates.

**Total Research Time**: ~34 minutes (including fallback strategy analysis and decision)

## Summary

**Problem**: `runnote-transition` generates broken metadata due to template path mismatch

**Root Cause**: Line 167 constructs incorrect path (`runnotes-dir "/template-" phase ".md"`) instead of using config-based `template-dir` and correct naming (`template-dir "/" phase ".md"`)

**Impact**: 18 files in ~/src/xional/runnotes/ with invalid EDN metadata

**Fix Approach**:
1. Fix `create-phase-file` to use correct template path resolution (template-dir parameter)
2. Remove broken fallback code, replace with fail-fast + recovery guidance
3. Migrate 18 affected files to valid metadata format
4. Validate fixes using `runnote-validate`

**Key Decision**: Use fail-fast approach (Option 1) - clear loud failure with recovery guidance, no silent corruption

**Validation**: `runnote-validate` correctly detects broken metadata - can be used to verify fixes

### [15:45] - Fallback Code Strategy Analysis

State: üü¢ Active

**Question**: What should we do with the fallback code (lines 170-175)?

**Strategic Options**:

#### Option 1: Remove Fallback - Fail Fast
```clojure
(defn create-phase-file
  [topic date current-phase context metadata template-dir runnotes-dir]
  (let [next-ph (next-phase current-phase)
        filename (str runnotes-dir "/RunNotes-" date "-" topic "-" next-ph ".md")
        template-file (str template-dir "/" next-ph ".md")
        template (if (fs/exists? template-file)
                  (slurp template-file)
                  (throw (ex-info "Template not found" {:template template-file})))]
    (spit filename template)
    filename))
```

**Pros**:
- Simplicity - single code path
- Fail fast principle - surface config issues immediately
- Matches `runnote-launch` behavior
- Forces proper template setup

**Cons**:
- Could disrupt workflow if template missing
- Less graceful degradation
- User experience: hard failure mid-transition

---

#### Option 2: Fix Fallback - Generate Valid EDN
```clojure
template (if (fs/exists? template-file)
          (slurp template-file)
          (str "# " (str/capitalize next-ph) ": " topic " - " date "\n\n"
               "```edn :metadata\n"
               "{:phase \"" next-ph "\"\n"
               " :tag " (:tags metadata) "\n"
               " :status :active\n"
               " :date {:created \"" date "\"}}\n"
               "```\n\n"
               "## Context From Previous Phase\n\n"
               context))
```

**Pros**:
- Defensive programming - never generates broken files
- Graceful degradation if template missing
- User can continue working

**Cons**:
- Maintains two code paths (complexity)
- Masks template configuration issues
- Fallback might have incomplete metadata

---

#### Option 3: Template Hierarchy - Project ‚Üí Global ‚Üí Fail
```clojure
(defn find-template-with-fallback
  "Try project template, then global template, then fail"
  [project-template-dir global-template-dir phase]
  (let [project-tpl (str project-template-dir "/" phase ".md")
        global-tpl (str global-template-dir "/" phase ".md")]
    (cond
      (fs/exists? project-tpl) project-tpl
      (fs/exists? global-tpl) global-tpl
      :else (throw (ex-info "Template not found"
                           {:tried [project-tpl global-tpl]})))))
```

**Pros**:
- Proper fallback hierarchy (matches config system)
- Project can override global templates
- No broken metadata generation
- Fail fast only if truly missing

**Cons**:
- More complex
- Requires both template-dir parameters
- Still fails hard if neither found

---

#### Option 4: Reuse Existing Code - Extract Template Resolution
```clojure
;; Extract find-template from runnote-launch to shared module
;; Both tools use identical template resolution
(require '[runnote.template-core :as tpl])

(defn create-phase-file
  [topic date current-phase context metadata template-dir runnotes-dir]
  (let [next-ph (next-phase current-phase)
        filename (str runnotes-dir "/RunNotes-" date "-" topic "-" next-ph ".md")
        template-file (tpl/find-template template-dir next-ph)]  ;; <-- reuse
    (spit filename (slurp template-file))
    filename))
```

**Pros**:
- DRY principle - single source of truth
- Consistent behavior across all tools
- Leverages tested code
- Simplest long-term maintenance

**Cons**:
- Requires refactoring to shared module
- More initial work
- Still fails fast (inherits runnote-launch behavior)

---

## Recommendation

**Hybrid: Option 3 (Template Hierarchy) with Option 4 (Code Reuse)**

**Rationale**:
1. **Correctness**: Never generate broken metadata
2. **User Experience**: Graceful fallback to global templates
3. **Maintainability**: Extract to shared module for consistency
4. **Fail Fast**: Only fail if templates truly missing (config issue)

**Implementation**:
1. Create `lib/template-core.clj` with `find-template` function
2. Use template hierarchy: project ‚Üí global ‚Üí fail
3. Both `runnote-launch` and `runnote-transition` use same code
4. Remove fallback metadata generation entirely

**Time**: 8 minutes

### [15:50] - Decision: Option 1 Selected

State: üü¢ Active

**Decision**: Proceed with **Option 1: Remove Fallback - Fail Fast**

**Rationale** (from stakeholder):
- Simplicity over complexity
- Clear, loud failure is better than silent corruption
- Provide recovery guidance in error message
- Matches `runnote-launch` behavior (consistency)

**Implementation Requirements**:

1. **Fix template path lookup**:
   ```clojure
   template-file (str template-dir "/" next-ph ".md")
   ```

2. **Remove fallback code** (lines 170-175), replace with fail-fast:
   ```clojure
   template (if (fs/exists? template-file)
             (slurp template-file)
             (throw (ex-info (str "Template not found: " template-file "\n\n"
                                 "Recovery steps:\n"
                                 "1. Check template directory configuration\n"
                                 "2. Verify template exists: " template-file "\n"
                                 "3. Run: runnote-init to setup templates\n"
                                 "4. Or create template manually in template/" next-ph ".md")
                            {:template-file template-file
                             :phase next-ph
                             :template-dir template-dir})))
   ```

3. **Add template-dir parameter** to function signature:
   - Current: `[topic date current-phase context metadata runnotes-dir]`
   - Updated: `[topic date current-phase context metadata template-dir runnotes-dir]`

4. **Update call site** (line 289) to pass `template-dir` from config

**Benefits of This Approach**:
- ‚úÖ Single code path (no branching complexity)
- ‚úÖ Surfaces configuration issues immediately
- ‚úÖ Clear recovery guidance in error message
- ‚úÖ Consistent with `runnote-launch` behavior
- ‚úÖ Prevents future broken metadata generation

**Time**: 3 minutes
**Status**: ‚úÖ Decision finalized, ready for planning phase
