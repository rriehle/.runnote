#!/usr/bin/env bb

(ns ^:clj-kondo/ignore runnote-validate
  "Validate RunNotes metadata for correctness and completeness.
   Detects malformed tags, missing required fields, and unfilled templates."
  (:require [clojure.string :as str]
            [babashka.fs :as fs]))

;; ============================================================================
;; Library Loading
;; ============================================================================

(def lib-dir (str (System/getenv "HOME") "/.lib"))
(load-file (str lib-dir "/config-core.bb"))
(load-file (str lib-dir "/metadata-parser.bb"))

(def parse-metadata (:parse-metadata metadata-parser/exports))
(def extract-edn-metadata (:extract-edn-metadata metadata-parser/exports))

;; ============================================================================
;; Configuration
;; ============================================================================

(defn load-runnote-config
  "Load RunNotes configuration and get runnote directory"
  []
  (let [config (config-core/load-config :runnote)]
    {:runnote-dir (config-core/resolve-runnote-dir config)}))

(def runnote-dir (:runnote-dir (load-runnote-config)))

;; ============================================================================
;; Validation Functions
;; ============================================================================

(defn validate-tag-structure
  "Check if all tags are keywords (not vectors, strings, or other types).
   Returns {:valid true} or {:valid false :errors [...]}"
  [metadata file-name]
  (if-let [tags (:tag metadata)]
    (let [invalid-tags (filter #(not (or (keyword? %) (symbol? %))) tags)]
      (if (empty? invalid-tags)
        {:valid true}
        {:valid false
         :errors [{:type :malformed-tags
                   :file file-name
                   :invalid-tags invalid-tags
                   :message (str "Tags must be keywords or symbols, found: "
                               (str/join ", " (map #(str % " (" (type %) ")") invalid-tags)))}]}))
    {:valid false
     :errors [{:type :missing-tags
               :file file-name
               :message "Required field :tag is missing"}]}))

(defn detect-template-placeholders
  "Detect unfilled template placeholders in metadata or content.
   Returns {:found false} or {:found true :placeholders [...]}"
  [metadata content file-name]
  (let [placeholder-patterns [#"\[Inherit from"
                              #"\[Import"
                              #"\[List\]"
                              #"YYYY-MM-DD"
                              #"HH:MM"
                              #"\[Topic\]"]
        metadata-str (pr-str metadata)
        title-line (first (str/split-lines content))
        found-in-metadata (filter #(re-find % metadata-str) placeholder-patterns)
        found-in-title (filter #(re-find % title-line) placeholder-patterns)]
    (if (or (seq found-in-metadata) (seq found-in-title))
      {:found true
       :file file-name
       :placeholders (concat
                      (when (seq found-in-metadata) ["metadata contains placeholders"])
                      (when (seq found-in-title) ["title contains placeholders"]))}
      {:found false})))

(defn check-required-fields
  "Check if all required metadata fields are present.
   Returns {:valid true} or {:valid false :missing-fields [...]}"
  [metadata file-name]
  (let [required-fields [:phase :tag :status :date]
        missing-fields (filter #(not (contains? metadata %)) required-fields)]
    (if (empty? missing-fields)
      {:valid true}
      {:valid false
       :file file-name
       :missing-fields missing-fields
       :message (str "Missing required fields: " (str/join ", " (map name missing-fields)))})))

(defn validate-file
  "Validate a single RunNotes file.
   Returns validation results map."
  [file]
  (let [content (slurp (str file))
        file-name (fs/file-name file)
        metadata (extract-edn-metadata content)]
    (if (:error metadata)
      {:file file-name
       :valid false
       :errors [{:type :parse-error
                 :message (:message metadata)}]}
      (let [tag-validation (validate-tag-structure metadata file-name)
            required-fields (check-required-fields metadata file-name)
            placeholder-check (detect-template-placeholders metadata content file-name)

            all-errors (concat
                        (when-not (:valid tag-validation) (:errors tag-validation))
                        (when-not (:valid required-fields) [required-fields]))

            all-warnings (when (:found placeholder-check)
                          [{:type :unfilled-template
                            :file file-name
                            :placeholders (:placeholders placeholder-check)}])]
        {:file file-name
         :valid (and (:valid tag-validation) (:valid required-fields))
         :errors (vec all-errors)
         :warnings (vec all-warnings)}))))

(defn validate-all
  "Validate all RunNotes files in the directory.
   Returns summary of validation results."
  []
  (let [files (fs/glob runnote-dir "RunNotes-*.md")
        results (map validate-file files)
        errors (filter #(seq (:errors %)) results)
        warnings (filter #(seq (:warnings %)) results)
        valid (filter #(:valid %) results)]
    {:total (count results)
     :valid (count valid)
     :errors (count errors)
     :warnings (count warnings)
     :details {:errors errors
               :warnings warnings}}))

;; ============================================================================
;; Display Functions
;; ============================================================================

(defn display-validation-results
  "Display validation results in a human-readable format."
  [results]
  (println "\nüîç RunNotes Validation Report")
  (println "============================")
  (println (str "Total Files: " (:total results)))
  (println (str "Valid: " (:valid results)))
  (println (str "Errors: " (:errors results)))
  (println (str "Warnings: " (:warnings results)))

  (when (pos? (:errors results))
    (println "\n‚ùå Files with Errors:")
    (doseq [result (get-in results [:details :errors])]
      (println (str "\n  " (:file result)))
      (doseq [error (:errors result)]
        (println (str "    - " (or (:message error) (:type error)))))))

  (when (pos? (:warnings results))
    (println "\n‚ö†Ô∏è  Files with Warnings:")
    (doseq [result (get-in results [:details :warnings])]
      (println (str "\n  " (:file result)))
      (doseq [warning (:warnings result)]
        (println (str "    - " (:type warning) ": " (str/join ", " (:placeholders warning)))))))

  (when (zero? (+ (:errors results) (:warnings results)))
    (println "\n‚úÖ All files are valid!")))

;; ============================================================================
;; Main
;; ============================================================================

(defn -main [& args]
  (let [results (validate-all)]
    (display-validation-results results)
    ;; Exit with error code if there are errors
    (when (pos? (:errors results))
      (System/exit 1))))

(-main)
